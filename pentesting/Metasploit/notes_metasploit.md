# Metasploit

## Resources and help
- <https://www.offsec.com/metasploit-unleashed/introduction/>
- <https://docs.metasploit.com/>

- man msfconsole
- man msfvenom


Config files: `/usr/share/metasploit-framework`
User specified modules: `~/.ms4/modules`




## Tips

### Create workspace for every assessment, because you can then go through all the information you gather. The MSF will store so you can go back to it:
```
> hosts
> services
> loot
> cred
```


### Also settings global options may come handy:
setg RHOST [TARGET]
setg RHOSTS [TARGET]





## Commands

### Start Metasploit Console
```
sudo msfdb init && msfconsole
sudo msfdb init && msfconsole -q
sudo msfconsole -q
```




### Move around and manage console

`back` to move out of the current context and return to the main prompt:
```
msf6 > use auxiliary/scanner/portscan/tcp
msf6 auxiliary(scanner/portscan/tcp) > back
msf6 >
```

- A variation of `back` is `previous`, which will switch us back to the previously selected module instead of the main prompt.



`ctrl+Z` or `background` Background session


### Sessions
```
sessions -l
sessions -i [NUMBER] # foreground session
sessions -u -[session number] # upgrade to shell?
```


### Workspaces
Used to organize out assessments

```
# first check the status of postgres
msf6 > db_status


# help
> workspace -h

# get info about workspace
> workspace # list workspaces
> hosts


# add workspace
> workspace -a [NAME]

# rename workspace
> workspace -r [OLD] [NEW]

# switch workspace
> workspace [WORKSPACE NAME]


```


## Nmap

### Import Nmap results
First save `nmap` scan as XML.

Then:
```
# after choosing or creating the workspace
db_import [PATH TO SCAN FILE]


> hosts
> services
> vulns

```

### Perform Nmap scan from within the MSF console
If you don't want to through the process of performing a nmap scan externally and the importing the result manually.

```
> db_nmap -Pn -sV etc etc etc [IP]

# The results will be automatically saved into the MSF database

```



### Search and use modules
```
show [MODULE TYPE]
show auxiliary
show all


search -h
search [KEYWORDS]
search type:[MODULE TYPE]
search type:auxiliary name:smb



use [NUMBER]
use [MODULE NAME]
show options


set [OPTION] [VALUE]
Example: set RHOST [IP]

set
setg
unset
unsetg


run
exploit

```



















## Meterpreter
meterpreter not the same as shell

Is a multi-function payload that can be dynamically extended at run-time. It's executed in memory on the target making it difficult to detect.

It communicates over a stager socket and provides an interactive command interpreter on the target system that facilitates the execution of system commands, file system navigation, keylogging, and more.

These tools are especially useful in the post-exploitation phase. Because of Meterpreterâ€™s flexibility and capability, it is the favorite and most commonly-used Metasploit payload.




### Meterpreter commands
```
help
search meterpreter type:payload



# Pivoting
run autoroute -s [new IP seen from 1st target]

# don't need to provide the subnet range, just the IP of one of the system on the private network



```



















## Multi Handler (msfvenom + metasploit)

```
> use multi/handler
> set PAYLOAD windows/x64/meterpreter/reverse_tcp
> run # or  `exploit -j` (to run as background job)


```




























