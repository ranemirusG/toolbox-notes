# Metasploit

## Resources and help
- <https://www.offsec.com/metasploit-unleashed/introduction/>
- <https://docs.metasploit.com/>

- man msfconsole
- man msfvenom


Config files: `/usr/share/metasploit-framework`
User specified modules: `~/.ms4/modules`

GUI - Armitage



## Tips

### Create workspace for every assessment, because you can then go through all the information you gather. The MSF will store so you can go back to it:
```
> hosts
> services
> cred
> loot
> notes
```


### Also settings global options may come handy:
setg RHOST [TARGET]
setg RHOSTS [TARGET]





## Commands

### Start Metasploit Console
```
service postgresql start && msfconsole
sudo msfdb init && msfconsole
sudo msfdb init && msfconsole -q
sudo msfconsole -q
```




### Move around and manage console

`back` to move out of the current context and return to the main prompt:
```
msf6 > use auxiliary/scanner/portscan/tcp
msf6 auxiliary(scanner/portscan/tcp) > back
msf6 >
```

- A variation of `back` is `previous`, which will switch us back to the previously selected module instead of the main prompt.



`ctrl+Z` or `background` Background session


### Sessions
```
sessions -l
sessions -i [NUMBER] # foreground session
sessions -u -[session number] # upgrade to shell

port/multi/manage/shell_to_meterpreter


# Save session to file
sessions -S <session_id> -f /path/to/save/session_file


```


### Output
```
msf6 > help spool

```


### Workspaces
Used to organize out assessments

```
# first check the status of postgres
msf6 > db_status


# help
> workspace -h

# get info about workspace
> workspace # list workspaces
> hosts


# add workspace
> workspace -a [NAME]

# rename workspace
> workspace -r [OLD] [NEW]

# switch workspace
> workspace [WORKSPACE NAME]


```


## Nmap

### Import Nmap results
First save `nmap` scan as XML.

Then:
```
# after choosing or creating the workspace
db_import [PATH TO SCAN FILE]


> hosts
> services
> vulns
> analyze

```

### Perform Nmap scan from within the MSF console
If you don't want to through the process of performing a nmap scan externally and the importing the result manually.

```
> db_nmap -Pn -sV etc etc etc [IP]

# The results will be automatically saved into the MSF database

```


### Search using `searchsploit`
And limit the results to MSF modules
```
searchsploit "[KEYWORD]" | grep -e "Metasploit"
searchsploit "Microsoft Windows SMB" | grep -e "Metasploit"
```



### Search and use modules
```
show [MODULE TYPE]
show auxiliary
show all


search -h
search [KEYWORDS]
search type:[MODULE TYPE]
search type:auxiliary name:smb



use [NUMBER]
use [MODULE NAME]
show options


set [OPTION] [VALUE]
Example: set RHOST [IP]

set
setg
unset
unsetg


run
exploit

```



















## Meterpreter

The Meterpreter (Meta-Interpreter) payload is an advanced multi-functional payload that operates via DLL injection and is executed in memory on the target system, consequently making it difficult to detect.

It communicates over a stager socket and provides an attacker with an interactive command interpreter on the target system that facilitates the execution of system commands, file system navigation, keylogging and much more.


MSF provides us with various types of meterpreter payloads that can be used based on the target environment and the OS architecture



These tools are especially useful in the post-exploitation phase. Because of Meterpreterâ€™s flexibility and capability, it is the favorite and most commonly-used Metasploit payload.

Meterpreter also allows us to load custom script and plugins dynamically.























### Meterpreter commands
Not all commands are the same for Linux and Windows
```
help
search meterpreter type:payload





sessions -h

sysinfo
getuid
getprivs
getenv [...]
getenv PATH
getenv TERM

# Search in specific directory
search -d /usr/bin -f *backdoor*

# Search through all the system
search -f *.jpg

# list processes / search process
ps
pgrep [name]


# migrate to process
migrate [ID]
migrate -N [PROCESS NAME]


# execute command on the target
execute -f [COMMAND]



checksum md5 [FILE]




# pop a shell on the target system
shell





#########################
Windows specific commands

# privesc
getsystem

hashdump

show_mount


screenshot
















# Pivoting
run autoroute -s [new IP seen from 1st target]

# don't need to provide the subnet range, just the IP of one of the system on the private network



```







