# Active Directory Lateral Movement

- <https://attack.mitre.org/tactics/TA0008/>

These techniques may use the current valid account or reuse authentication material such as password hashes, Kerberos Otickets, and application access tokens obtained from the previous attack stages.




## WMI and WinRM
Windows Management Instrumentation is an object-oriented feature that facilitates task automation.

The `wmic` utility has been recently deprecated.

We need credentials of a member of the Administrators local group, which can also be a domain user.



```
wmic /node:192.168.50.73 /user:jen /password:Nexus123! process call create "calc"
```



### Using PowerShell
Translating this attack into PowerShell syntax requires a few extra details.

First, We need to create a `PSCredential` object that will store our session username and password.

To do that, we will first store the username and password in variables.

Then, we will secure the password via the `ConvertTo-SecureString` cmdlet. 

Finally, we'll create a new `PSCredential` object with the username variable and `secureString` object.


```
$username = 'jen';
$password = 'Nexus123!';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
```
- <https://learn.microsoft.com/en-us/powershell/scripting/learn/deep-dives/add-credentials-to-powershell-functions?view=powershell-7.4>

Now that we have our `PSCredential` object, we need to create a Common Information Model (CIM) via the `New-CimSession` cmdlet.

To do that, we'll first specify DCOM as the protocol for the WMI session with the `New-CimSessionOption` cmdlet on the first line. On the second line, we'll create the new session, `New-Cimsession` against our target IP, using `-ComputerName` and supply the `PSCredential` object (-Credential $credential) along with the session options (-SessionOption $Options). Lastly, we'll define 'calc' as the payload to be executed by WMI.

```
$options = New-CimSessionOption -Protocol DCOM
$session = New-Cimsession -ComputerName 192.168.214.72 -Credential $credential -SessionOption $Options
$command = 'calc';
```

As a final step, we need to tie together all the arguments we configured previously by issuing the `Invoke-CimMethod` cmdlet and supplying `Win32_Process` to the ClassName and Create to the MethodName. To send the argument, we wrap them in `@{CommandLine =$Command}`.

```
Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =$Command};
```











## PsExec
Part of SysInternals.

It's intended to replace telnet-like applications and provide remote execution of processes on other systems through an interactive console.





3 requisites must be met.

1. the user that authenticates to the target machine needs to be part of the Administrators local group
2. the ADMIN$ share must be available
3. File and Printer Sharing has to be turned on

Luckily for us, the last two requirements are already met as they are the default settings on modern Windows Server systems.






To execute the command remotely, PsExec performs the following tasks:

- Writes psexesvc.exe into the C:\Windows directory
- Creates and spawns a service on the remote host
- Runs the requested program/command as a child process of psexesvc.exe



```
PsExec64.exe -i  \\FILES04 -u corp\jen -p Nexus123! cmd
```












## Pash the Hash (PtH)

Authenticate to a remote system or service using a user's NTLM hash instead of the user's plaintext password.
(This will only work for servers or services using NTLM authentication, not for servers or services using Kerberos)

- PsExec from Metasploit
- Passing-the-hash toolkit (<https://github.com/byt3bl33d3r/pth-toolkit>)
- Impacket





Most tools that are built to abuse PtH can be leveraged to start a Windows service (for example, cmd.exe or an instance of PowerShell) and communicate with it using Named Pipes. This is done using the Service Control Manager API.

Unless we want to gain remote code execution, PtH does not need to create a Windows service for any other usage, such as accessing an SMB share.


Same requisites as PsExec.




### Impacket

```
/usr/bin/impacket-wmiexec -hashes :2892D26CDF84D7A70E2EB3B9F05C425E Administrator@192.168.220.73
```



If the target was sitting behind a network that was only reachable through our initial compromised access, we could perform this very same attack by pivoting and proxying through the first host






## Overpass the Hash
With overpass the hash, we can "over" abuse an NTLM user hash to gain a full Kerberos Ticket Granting Ticket (TGT). Then we can use the TGT to obtain a Ticket Granting Service (TGS).





