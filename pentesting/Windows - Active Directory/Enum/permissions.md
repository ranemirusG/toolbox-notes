# Enumerate Object Permissions

An object in AD may have a set of permissions applied to it with multiple Access Control Entries (ACE).
These ACEs make up the Access Control List (ACL).
Each ACE defines whether access to the specific object is allowed or denied.


The ACL validation involves two main steps:

1. In an attempt to access the share, the user will send an access token, which consists of the user identity and permissions.

2. The target object will then validate the token against the list of permissions (the ACL). If the ACL allows the user to access the share, access is granted. Otherwise the request is denied.


AD includes a wealth of permission types that can be used to configure an ACE.
- <https://learn.microsoft.com/en-us/dotnet/api/system.directoryservices.activedirectoryrights?view=netframework-4.7.2>
- <https://learn.microsoft.com/en-us/windows/win32/secauthz/access-rights-and-access-masks>



However, from an attacker's standpoint, we are mainly interested in a few key permission types. Here is a list of the most interesting ones along with a description of the permissions they provide:
```
GenericAll: Full permissions on object
GenericWrite: Edit certain attributes on the object
WriteOwner: Change ownership of the object
WriteDACL: Edit ACE's applied to object
AllExtendedRights: Change password, reset password, etc.
ForceChangePassword: Password change for object
Self (Self-Membership): Add ourselves to for example a group
```









## Using PowerView
identify which security principals (users or groups) have full control (all permissions) over the given object

```
# enumerate our own user to determine which ACEs are applied to it
Get-ObjectAcl -Identity [USERNAME]
Get-ObjectAcl -Identity stephanie
```

Interesting properties:
- ObjectSID
- ActiveDirectoryRights (describes the type of permission applied to the object)
- SecurityIdentifier


<https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers>



PowerView's `Convert-SidToName`
```
> Convert-SidToName S-1-5-21-1987370270-658905905-1781884369-1104
> CORP\stephanie
```



```
Get-ObjectAcl -Identity "robert" | 
    Where-Object { $_.ActiveDirectoryRights -eq "GenericAll" } |
    Select-Object -ExpandProperty SecurityIdentifier | 
    ForEach-Object { Convert-SidToName $_ }
```




My script!
```
<# 

Show AD permissions for objects with GenericAll rights.

@ranemirusG 2024
#>
 
# Define a hash table with permissions and their descriptions
$permissions = @{
    "GenericAll"            = "Full permissions on object"
    "GenericWrite"          = "Edit certain attributes on the object"
    "WriteOwner"            = "Change ownership of the object"
    "WriteDACL"             = "Edit ACE's applied to object"
    "AllExtendedRights"     = "Change password, reset password, etc."
    "ForceChangePassword"   = "Password change for object"
    "Self"                  = "Self-Membership: Add ourselves to, for example, a group"
}

# Initialize a hash table to store ObjectWithRights and associated users per permission
$objectRights = @{}

# Get the list of usernames and loop through each
Get-NetUser | Select-Object -ExpandProperty name | ForEach-Object {
    $username = $_
    
    # Loop through each permission
    foreach ($permission in $permissions.Keys) {
        # Run Get-ObjectAcl for the current username and filter for the specified rights
        $results = Get-ObjectAcl -Identity $username | 
            Where-Object { $_.ActiveDirectoryRights -eq $permission }
        
        # Process each result to build the hash table
        foreach ($result in $results) {
            # Convert SID to name
            $objectName = Convert-SidToName $result.SecurityIdentifier
            
            # Add to hash table or update it
            if (-not $objectRights.ContainsKey($objectName)) {
                $objectRights[$objectName] = @{}
            }
            if (-not $objectRights[$objectName].ContainsKey($permission)) {
                $objectRights[$objectName][$permission] = @($username)
            } else {
                $objectRights[$objectName][$permission] += $username
            }
        }
    }
}

# Output the results in a clear format
foreach ($object in $objectRights.Keys) {
    Write-Host "$object has the following permissions:"
    foreach ($permission in $objectRights[$object].Keys) {
        Write-Host "  - $permissions[$permission] ($permission):"
        foreach ($user in $objectRights[$object][$permission]) {
            Write-Host "    - $user"
        }
    }
    Write-Host "" # Add a blank line for better readability
}


```









Find-InterestingDomainAcl




