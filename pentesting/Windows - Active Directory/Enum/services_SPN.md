# Services / Service Principal Names
```
wmic services list full
```


Continue our enumeration by focusing on a different type of user, more specifically Service Accounts.

Services launched by the system itself run in the context of a Service Account such as LocalSystem, LocalService and NetworkService.


When applications like Exchange,MS SQL, or Internet Information Services (IIS) are integrated into AD, a unique service instance identifier known as Service Principal Name (SPN) associates a service to a specific service account in Active Directory.

Service Principal Names (SPNs) are unique identifiers for services running on servers in an Active Directory (AD) environment. SPNs are used by Kerberos authentication to associate a service instance with a service logon account (like a user or computer account) in AD. This allows clients to locate and authenticate a specific service instance.

```
<service>/<hostname>:<port>/<service name>

MSSQLSvc/sqlserver.example.com:1433
```

Managed Service Accounts, introduced with Windows Server 2008 R2, were designed for complex applications, which require tighter integration with Active Directory.

- < https://learn.microsoft.com/en-us/windows-server/security/group-managed-service-accounts/group-managed-
service-accounts-overview>
 



We can obtain the IP address and port number of applications running on servers integrated with AD by simply enumerating all SPNs in the domain:

- `setspn.exe` (use `-L` to run against both servers and clients in the domain)

```
setspn -L iis_service
```




Script:
- <https://raw.githubusercontent.com/compwiz32/PowerShell/master/Get-SPN.ps1>
```
$search = New-Object DirectoryServices.DirectorySearcher([ADSI]"")
$search.filter = "(servicePrincipalName=*)"

## You can use this to filter for OU's:
## $results = $search.Findall() | ?{ $_.path -like '*OU=whatever,DC=whatever,DC=whatever*' }
$results = $search.Findall()

foreach( $result in $results ) {
	$userEntry = $result.GetDirectoryEntry()
	Write-host "Object Name = " $userEntry.name -backgroundcolor "yellow" -foregroundcolor "black"
	Write-host "DN      =      "  $userEntry.distinguishedName
	Write-host "Object Cat. = "  $userEntry.objectCategory
	Write-host "servicePrincipalNames"

	$i=1
	foreach( $SPN in $userEntry.servicePrincipalName ) {
		Write-host "SPN(" $i ")   =      " $SPN
		$i+=1
	}
	Write-host ""
}
```
























- With PowerView:
```
Get-NetUser -SPN | select samaccountname,serviceprincipalname
```

Then attempt to resolve the result with `nslookup.exe`:
```
nslookup.exe web04.corp.com
ping web04
Resolve-IpAddress CLIENT76.corp.com
```






