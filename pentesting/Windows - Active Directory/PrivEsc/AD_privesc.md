# Active Directory Privilege Escalation

- <https://infosecwriteups.com/privilege-escalation-in-windows-380bee3a2842>


Privilege escalation is the process of exploiting vulnerabilities or misconfigurations in systems to elevate privileges from one user to another, typically to a user with administrative or root access on a system.

When the time comes to escalate our privileges, we don't necessarily need to immediately escalate to Domain Admins because there may be other accounts that have higher privileges than a regular domain user, even if they aren't necessarily a part of the Domain Admins group.

Service Accounts are a good example of this. Although they may not always have the highest privilege possible, they may have more permissions than a regular domain user, such as local administrator privileges on specific servers.

In addition, an organization's most sensitive and important a data may be stored in locations that do not require domain administrator privileges, o that obtaining domain administrator privileges a should not always be the end goal during an assessment since we may be able to reach the "crown jewels" for an organization via other users in the domain.


When an attacker or penetration tester improves access through multiple higher-level accounts to reach a goal, it is known as a chained compromise.




It's possible to gain code execution with elevated privileges on a remote computer if you have WRITE privilege on that computer's AD object.


NT Authority\SYSTEM
Administrator









## Some commands




- Use ExecutionPolicy Bypass: Allows the script to run even if the PowerShell execution policy is restrictive.
```
powershell.exe -ExecutionPolicy Bypass -File C:\Temp\your_script.ps1

powershell -ep bypass
```






Check if the UAC is really bypassable
```
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System 
```
If the return `ConsentPromptBehaviorAdmin` value is 5, it means it is using the default setting for UAC.

- <https://github.com/ScriptKiddieTutorials/Bypass-UAC?tab=readme-ov-file>




# run as administrator
Start-Process powershell -Verb runas
start powershell -Verb runas
Start-Process wt -Verb runAs
powershell -Command "Start-Process powershell -Verb runas"

- <https://superuser.com/questions/42537/is-there-any-sudo-command-for-windows>

runas /noprofile /user:Administrator cmd 


# execute command as admin
- <https://stackoverflow.com/questions/7690994/running-a-command-as-administrator-using-powershell>

```
if (!([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")) { Start-Process powershell.exe "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`"" -Verb RunAs; exit }

# script here
```




# tell whether it's an elevated permision terminal session
# 1 - Returns "True" if elevated
(New-Object Security.Principal.WindowsPrincipal([Security.Principal.WindowsIdentity]::GetCurrent())).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
# 2 - workaround (if NOT elevated returns: "Access is denied.")
net session # 
















# Sysinternals
# list all the permissions of a given domain user
accesschk “domain\user” -a * -nobanner
# see the security on the HKLM\Software key:
accesschk -k hklm\software







User accounts: `netpzwiz`

Local Users and Groups: `lusrmgr.msc`

Local Security Settings: `secpol.msc`

Local Group Policy Editor: `gpedit.msc`








- Open powershell as another user (1):
```
$username = 'username'
$password = 'password'
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword
Start-Process powershell.exe -Credential $credential
```

- Open powershell as another user (2):
```
$credentialParams = @{
    UserName = 'username'
    Password = 'password' | ConvertTo-SecureString -AsPlainText -Force
}

$credential = New-Object System.Management.Automation.PSCredential @credentialParams

$processParams = @{
    FilePath = 'powershell.exe'
    Credential = $credential
}

Start-Process @processParams
```





















- log as another user

1. GUI option: log out and then log in as the other user

2. Command line option:
```
runas /user:corp\jen powershell.exe

runas /user:marketingwk02\steve powershell

```

- log as another user on another machine
```
Enable-PSRemoting -Force
Enter-PSSession -ComputerName DC1 -Credential corp\Administrator

# Alternatively, if you want to automate the credentials prompt, you can do:
$cred = Get-Credential corp\Administrator
Enter-PSSession -ComputerName DC1 -Credential $cred

```


```
PsExec64.exe -i  \\FILES04 -u corp\jen -p Nexus123! cmd
```




- check if you have elevated privileges (administrator rights) in PowerShell
```
# True if you're Admin / False if not
([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
```


- Check If You Can Elevate by Attempting to Start a New Elevated Process
```
# Attempt to create a new elevated PowerShell process
Start-Process -FilePath "powershell.exe" -ArgumentList "-Command `"Exit 0`"" -Verb RunAs -ErrorAction Stop
```




MIC
- <https://en.wikipedia.org/wiki/Mandatory_Integrity_Control>

- untrusted 0 (guests)
- low 1 (browsers)
- medium 2 (usuario estandar)
- high 3 (usuario privilegiado/admin)



#### accesschk

```
acceschk -uwcqv "irving" * -accepteula
cs qc daclsvc
sc config "daclsvc" binPath="net localgroup Administradores Irving /add" 
sc start daclsvc
```

















## User Account Control (UAC) 

IMPORTANT: in order to successfully bypass UAC, we will need to have access to a user account that is a part of the local administrators group on the Windows target system. `net localgroup administrators`

User Account Control (UAC) is a Windows security feature introduced in Windows Vista that is used to prevent unauthorized changes from being made to the operating system.

UAC is used to ensure that changes to the operating system require approval from the administrator or a user account that is part of the local administrators group.

A non-privileged user attempting to execute a program with elevated privileges will be prompted with the UAC credential prompt, whereas a privileged user will be prompted with a consent prompt.


UAC has various integrity levels ranging from low to high, if the UAC protection level is set below high, Windows programs can be executed with elevated privileges without prompting the user for confirmation.













## Windows Access Tokens

Windows access tokens are a core element of the authentication process on Windows and are created and managed by the Local Security Authority Subsystem Service (LSASS).

A Windows access token is responsible for identifying and describing the security context of a process or thread running on a system. Simply put, an access token can be thought of as a temporary key akin to a web cookie that provides users with access to a system or network resource without having to provide credentials each time a process is started or a system resource is accessed.

Access tokens are generated by the `winlogon.exe` process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the `userinit.exe` process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.


The following are the privileges that are required for a successful impersonation attack:
- `SeAssignPrimaryToken`: This allows a user to impersonate tokens.
- `SeCreateToken`: This allows a user to create an arbitrary token with administrative privileges.
- `SeImpersonatePrivilege`: This allows a user to create a process under the security context of another user typically with administrative privileges.











































## Windows Kernel

A Kernel is a computer program that is the core of an operating system and has complete control over every resource and hardware on a system.
It acts as a translation layer between hardware and software and facilitates the communication between these two layers.

`Windows NT` is the kernel that comes pre-packaged with all versions of Microsoft Windows and operates as a traditional kernel with a few exceptions based on user design philosophy. It consists of two main modes of operation that determine access to system resources and hardware:

- User Mode: Programs and services running in user mode have limited access to system resources and functionality.

- Kernel Mode: Kernel mode has unrestricted access to system resources and functionality with the added functionality of managing devices and system memory.



Kernel exploits on Windows will typically target vulnerabilities In the Windows kernel to execute arbitrary code in order to run privileged system commands or to obtain a system shell.

This process will differ based on the version of Windows being targeted and the kernel exploit being used.

Privilege escalation on Windows systems will typically follow the following methodology:
- Identifying kernel vulnerabilities
- Downloading, compiling and transferring kernel exploits onto the target
system.










