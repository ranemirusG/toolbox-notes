# AV Evasion

Generally speaking, antivirus evasion falls into two broad categories: on-disk and in-memory.

On-disk evasion focuses on modifying malicious files physically stored on disk in an attempt to evade AV file engine detections.

However, given the maturity of modern AV file scanning engines, modern malware often attempts in-memory operation, which avoids the disk entirely and therefore, reduces the possibility of being detected.


## On-Disk Evasion


Highly effective antivirus evasion requires a combination of this techniques in addition to other advanced ones, including anti-reversing, anti-debugging, virtual machine emulation detection, and so on.

In most cases, software protectors were designed for legitimate purposes, like anti-copy, but can also be used to bypass AV detection.



### Packers
One of the earliest ways of avoiding detection.

Given the high cost of disk space and slow network speeds during the early days of the internet, packers were originally designed to reduce the size of an executable.

Unlike modern "zip" compression techniques, packers generate an executable that is not only smaller, but is also functionally equivalent with a completely new binary structure. The file produced has a new hash signature and as a result, can effectively bypass older and more simplistic AV scanners. 

Even though some modern malware uses a variation of this technique, the use of UPX and other popular packers alone is not sufficient to evade modern AV scanners.

- <https://upx.github.io/>





### Obfuscators
Obfuscators reorganize and mutate code in a way that makes it more difficult to reverse-engineer. 

This includes replacing instructions with semantically equivalent ones, inserting irrelevant instructions or dead code, splitting or reordering functions, and so on.

- <https://en.wikipedia.org/wiki/Dead_code>

Although primarily used by software developers to protect their intellectual property, this technique is also marginally effective against signature-based AV detection.

Modern obfuscators also have runtime in-memory capabilities, which aims to hinder AV detection even further.




### Crypter software / Encryption
Cryptographically alters executable code, adding a decryption stub that restores the original code upon execution.

This decryption happens in-memory, leaving only the encrypted code on-disk. 

This encryption can make it significantly more difficult for antivirus and security software to detect the malicious code, as it appears as encrypted data rather than executable code.

Encryption has become foundational in modern malware as one of the most effective AV evasion techniques.
















## In-Memory Evasion
Also known as PE Injection.


Popular on Windows machines.


- <https://blog.f-secure.com/memory-injection-like-a-boss/>




### Remote Process Memory Injection
Attempts to inject the payload into another valid PE that is not malicious. 

The most common method of doing this is by leveraging a set of Windows APIs.

First, we would use the `OpenProcess` function to obtain a valid HANDLE to a target process that we have permission to access. After obtaining the HANDLE, we would allocate memory in the context of that process by calling a Windows API such as `VirtualAllocEx`.

Once the memory has been allocated in the remote process, we would copy the malicious payload to the newly allocated memory using `WriteProcessMemory`.

After the payload has been successfully copied, it is usually executed in memory in a separate thread using the `CreateRemoteThread` API.


### Reflective DLL Injection
The main challenge of implementing this technique is that LoadLibrary does not support loading a DLL from memory. Furthermore, the Windows operating system does not expose any APIs that can handle this either. Attackers who choose to use this technique must write their own version of the API that does not rely on a disk-based DLL.

- <https://andreafortuna.org//2017/12/08/what-is-reflective-dll-injection-and-how-can-be-detected/>



### Process Hollowing
When using process hollowing to bypass antivirus software, attackers first launch a non-malicious process in a suspended state. Once launched, the image of the process is removed from memory and replaced with a malicious executable image. Finally, the process is then resumed and malicious code is executed instead of the legitimate process.

- <https://www.ired.team/offensive-security/code-injection-process-injection/process-hollowing-and-pe-image-relocations>


### Inline hooking
Is a technique often employed by rootkits, a more stealthy kind of malware. 

Rootkits aim to provide the malware author dedicated and persistent access to the target system through modification of system components in user space, kernel, or even at lower OS protection rings such as boot or hypervisor.

Since rootkits need administrative privileges to implant its hooks, it is often installed from an elevated shell or by exploiting a privilege-escalation vulnerability.












## Resources / Tools
- <https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell>
- <https://www.enigmaprotector.com/en/home.html>

- <https://www.microsoft.com/en-us/security/blog/2018/03/01/finfisher-exposed-a-researchers-tale-of-defeating-traps-tricks-and-complex-virtual-machines/>
- <https://web.archive.org/web/20210317102554/https://wikileaks.org/ciav7p1/cms/files/BypassAVDynamics.pdf>

