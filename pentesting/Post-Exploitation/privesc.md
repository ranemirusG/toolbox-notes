# Privilege Escalation

Privilege escalation is the process of exploiting vulnerabilities or misconfigurations in systems to elevate privileges from one user to another, typically to a user with administrative or root access on a system.

After gaining an initial foothold on a target system you will be required to elevate your privileges in order to perform tasks and functionality that require administrative privileges.





## Windows


Administrator
NT Authority


### Windows Kernel

A Kernel is a computer program that is the core of an operating system and has complete control over every resource and hardware on a system.
It acts as a translation layer between hardware and software and facilitates the communication between these two layers.

`Windows NT` is the kernel that comes pre-packaged with all versions of Microsoft Windows and operates as a traditional kernel with a few exceptions based on user design philosophy. It consists of two main modes of operation that determine access to system resources and hardware:

- User Mode: Programs and services running in user mode have limited access to system resources and functionality.

- Kernel Mode: Kernel mode has unrestricted access to system resources and functionality with the added functionality of managing devices and system memory.



Kernel exploits on Windows will typically target vulnerabilities In the Windows kernel to execute arbitrary code in order to run privileged system commands or to obtain a system shell.

This process will differ based on the version of Windows being targeted and the kernel exploit being used.

Privilege escalation on Windows systems will typically follow the following methodology:
- Identifying kernel vulnerabilities
- Downloading, compiling and transferring kernel exploits onto the target
system.






### User Account Control (UAC) 

IMPORTANT: in order to successfully bypass UAC, we will need to have access to a user account that is a part of the local administrators group on the Windows target system. `net localgroup administrators`

User Account Control (UAC) is a Windows security feature introduced in Windows Vista that is used to prevent unauthorized changes from being made to the operating system.

UAC is used to ensure that changes to the operating system require approval from the administrator or a user account that is part of the local administrators group.

A non-privileged user attempting to execute a program with elevated privileges will be prompted with the UAC credential prompt, whereas a privileged user will be prompted with a consent prompt.


UAC has various integrity levels ranging from low to high, if the UAC protection level is set below high, Windows programs can be executed with elevated privileges without prompting the user for confirmation.




### Windows Access Tokens

Windows access tokens are a core element of the authentication process on Windows and are created and managed by the Local Security Authority Subsystem Service (LSASS).

A Windows access token is responsible for identifying and describing the security context of a process or thread running on a system. Simply put, an access token can be thought of as a temporary key akin to a web cookie that provides users with access to a system or network resource without having to provide credentials each time a process is started or a system resource is accessed.

Access tokens are generated by the `winlogon.exe` process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the `userinit.exe` process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.


The following are the privileges that are required for a successful impersonation attack:
- `SeAssignPrimaryToken`: This allows a user to impersonate tokens.
- `SeCreateToken`: This allows a user to create an arbitrary token with administrative privileges.
- `SeImpersonatePrivilege`: This allows a user to create a process under the security context of another user typically with administrative privileges.







### Active Directory

It's possible to gain code execution with elevated privileges on a remote computer if you have WRITE privilege on that computer’s AD object.






#### Some commands
- check if you have elevated privileges (administrator rights) in PowerShell
```
# True if you're Admin / False if not
([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
```


- Check If You Can Elevate by Attempting to Start a New Elevated Process
```
# Attempt to create a new elevated PowerShell process
Start-Process -FilePath "powershell.exe" -ArgumentList "-Command `"Exit 0`"" -Verb RunAs -ErrorAction Stop
```












## Linux
`sudo -l`
list the privileges for the invoking user (or the user specified by the -U option)

`find / -type f -perm -u=s 2>/dev/null`
The SUID bit is a special permission in Unix/Linux systems that allows a file to be executed with the permissions of the file's owner rather than the user who executed the file.


`bash -p`
The -p persists the permissions, so that it can run as root with SUID- as otherwise bash will sometimes drop the permissions.






### Linux Kernel Exploitation

Kernel exploits on Linux will typically target vulnerabilities In the Linux kernel to execute arbitrary code in order to run privileged system commands or to obtain a system shell.
●This process will differ based on the Kernel version and distribution being targeted and the kernel exploit being used.
●Privilege escalation on Linux systems will typically follow the following methodology:
- Identifying kernel vulnerabilities
- Downloading, compiling and transferring kernel exploits onto the target system.


Linux-Exploit-Suggester - This tool is designed to assist in detecting security deficiencies for given Linux kernel/Linux-based machine. It assesses (using heuristics methods) the exposure of the given kernel on every publicly known Linux kernel exploit.
- GitHub: https://github.com/mzet-/linux-exploit-suggester

















### Exploiting Misconfigured Cron Jobs

```
# show cronjob set for current user
crontab -l

# identify wheter a not privileged user string is in any script
cd /
grep -rnw /usr -r "/home/[NOT PRIVELIGED USER]/[ROOT OWNED BIN]"
```


Linux implements task scheduling through a utility called Cron.

Cron is a time-based service that runs applications, scripts and other commands repeatedly on a specified schedule.

An application, or script that has been configured to be run repeatedly with 

Cron is known as a Cron job. Cron can be used to automate or repeat a wide variety of functions on a system, from daily backups to system upgrades and patches.

The crontab file is a configuration file that is used by the Cron utility to store and track Cron jobs that have been created.



Cron jobs can also be run as any user on the system, this is a very important factor to keep an eye on as we will be targeting Cron jobs that have been configured to be run as the `root` user.
This is primarily because, any script or command that is run by a Cron job will run as the root user and will consequently provide us with root access.
In order to elevate our privileges, we will need to find and identify cron jobs scheduled by the root user or the files being processed by the cron job.











### Exploiting SUID Binaries

In addition to the three main file access permissions (read, write and execute), Linux also provides users with specialized permissions that can be utilized in specific situations. One of these access permissions is the SUID (Set Owner User ID) permission.

When applied, this permission provides users with the ability to execute a script or binary with the permissions of the file owner as opposed to the user that is running the script or binary.

SUID permissions are typically used to provide unprivileged users with the ability to run specific scripts or binaries with “root” permissions. It is to be noted, however, that the provision of elevate privileges is limited to the execution of the script and does not translate to elevation of privileges, however, if improperly configured unprivileged users can exploit misconfigurations or vulnerabilities within the binary or script to obtain an elevated session.



This is the functionality that we will be attempting to exploit in order to elevate our privileges, however, the success of our attack will depend on the following factors:

- Owner of the SUID binary – Given that we are attempting to elevate our privileges, we will only be exploiting SUID binaries that are owned by the `root` user or other privileged users.

- Access permissions – We will require executable permissions in order to execute the SUID binary.














### Linux Password Hashes

Linux has multi-user support and as a result, multiple users can access the system simultaneously. This can be seen as both an advantage and disadvantage from a security perspective, in that, multiple accounts offer multiple access vectors for attackers and therefore increase the overall risk of the server.

All of the information for all accounts on Linux is stored in the passwd file located in: `/etc/passwd`

We cannot view the passwords for the users in the passwd file because they are encrypted and the passwd file is readable by any user on the system.

All the encrypted passwords for the users are stored in the shadow file. it can be found in the following directory: `/etc/shadow`

The shadow file can only be accessed and read by the root account, this is a very important security feature as it prevents other accounts on the system from accessing the hashed passwords.



The passwd file gives us information in regards to the hashing algorithm that is being used and the password hash, this is very helpful as we are able to determine the type of hashing algorithm that is being used and its strength. We can determine this by looking at the number after the username encapsulated by the dollar symbol ($).

Value	Hashing Algorithm
$1		MD5
$2		Blowfish
$5		SHA-256
$6		SHA-512

















## Tools


### MSF

```
meterpreter > getpriv
meterpreter > getsystem

```


/post/multi/recon/local_exploit_suggester


